{% extends "base.html" %}

{% block title %}Russian Roulette - Game{% endblock %}

{% block content %}
<div class="card">
    <h1>ğŸ¯ Russian Roulette</h1>
    <div class="revolver" id="revolver">ğŸ”«</div>

    <div class="game-info">
        <div class="chamber-display">
            <strong>Chamber: <span id="currentChamber">0</span> / 6</strong>
        </div>
        <div style="margin: 10px 0;">
            <strong>Current Player: <span id="currentPlayerName">{{ current_player }}</span></strong>
        </div>
    </div>

    <div class="player-list" id="playerList">
        <h3>Players:</h3>
        <div id="playersContainer">
            {% for player in players %}
            <div class="player-item {% if player == current_player %}current{% endif %}" data-player="{{ player }}">
                <span>ğŸ‘¤ {{ player }}</span>
                <span class="player-status">Alive</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="gameControls" style="margin: 30px 0;">
        <button id="pullTriggerBtn" onclick="pullTrigger()" class="btn">
            ğŸ”« Pull Trigger
        </button>
        <button onclick="resetGame()" class="btn btn-secondary">
            ğŸ”„ Reset Game
        </button>
        <a href="{{ url_for('setup') }}" class="btn btn-success">
            ğŸ‘¥ New Players
        </a>
    </div>

    <div id="gameOverScreen" style="display: none; background: #f8f9fa; border-radius: 10px; padding: 20px; margin: 20px 0;">
        <h2 id="gameOverTitle">Game Over!</h2>
        <p id="gameOverMessage"></p>
        <div style="margin: 20px 0;">
            <button onclick="playAgain()" class="btn btn-success">
                ğŸ® Play Again
            </button>
            <a href="{{ url_for('setup') }}" class="btn btn-secondary">
                ğŸ‘¥ Change Players
            </a>
        </div>
    </div>

    <div class="message-container" id="messageContainer"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let gameState = {
    players: {{ players | tojson }},
    currentPlayer: "{{ current_player }}",
    isGameOver: false,
    currentChamber: 0
};

function pullTrigger() {
    const btn = document.getElementById('pullTriggerBtn');
    const revolver = document.getElementById('revolver');

    btn.disabled = true;
    btn.textContent = 'ğŸ”„ Pulling...';

    // Add suspense with revolver animation
    revolver.style.animation = 'spin 1s ease-in-out';

    setTimeout(() => {
        fetch('/pull_trigger', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateGameState();

                if (data.result === 'bullet') {
                    handleGameOver(data);
                } else {
                    handleEmptyChamber(data);
                }
            } else {
                showMessage(data.message, 'error');
            }
        })
        .catch(error => {
            showMessage('Error occurred while pulling trigger', 'error');
            console.error('Error:', error);
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'ğŸ”« Pull Trigger';
        });
    }, 1000);
}

function handleEmptyChamber(data) {
    showMessage(data.message, 'success');
    gameState.currentPlayer = data.current_player;
    updateCurrentPlayerDisplay();

    // Add click sound effect simulation
    setTimeout(() => {
        showMessage('*Click* - Empty chamber!', 'success');
    }, 500);
}

function handleGameOver(data) {
    gameState.isGameOver = true;

    // Update player status
    const playerItems = document.querySelectorAll('.player-item');
    playerItems.forEach(item => {
        const playerName = item.dataset.player;
        const statusSpan = item.querySelector('.player-status');

        if (playerName === gameState.currentPlayer) {
            item.classList.add('eliminated');
            item.style.background = '#ffebee';
            item.style.borderLeftColor = '#f44336';
            statusSpan.textContent = 'ğŸ’€ Eliminated';
            statusSpan.style.color = '#d32f2f';
        }

        item.classList.remove('current');
    });

    // Show game over screen
    document.getElementById('gameControls').style.display = 'none';
    const gameOverScreen = document.getElementById('gameOverScreen');
    gameOverScreen.style.display = 'block';

    document.getElementById('gameOverTitle').textContent = 'ğŸ’€ Game Over!';
    document.getElementById('gameOverMessage').innerHTML = `
        <strong>${data.message}</strong><br>
        <span style="color: #27ae60; font-size: 1.2em;">ğŸ† Winner: ${data.winner}</span>
    `;

    // Add dramatic effect
    setTimeout(() => {
        showMessage('ğŸ’¥ BANG! Game Over!', 'error');
    }, 500);
}

function updateCurrentPlayerDisplay() {
    // Update current player highlight
    const playerItems = document.querySelectorAll('.player-item');
    playerItems.forEach(item => {
        item.classList.remove('current');
        if (item.dataset.player === gameState.currentPlayer) {
            item.classList.add('current');
        }
    });

    document.getElementById('currentPlayerName').textContent = gameState.currentPlayer;
}

function updateGameState() {
    fetch('/get_game_state')
        .then(response => response.json())
        .then(data => {
            gameState = data;
            document.getElementById('currentChamber').textContent = data.current_chamber;
        })
        .catch(error => {
            console.error('Error getting game state:', error);
        });
}

function resetGame() {
    if (confirm('Are you sure you want to reset the game? This will start over with the same players.')) {
        fetch('/reset_game', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                showMessage('Error resetting game', 'error');
            }
        })
        .catch(error => {
            showMessage('Error resetting game', 'error');
            console.error('Error:', error);
        });
    }
}

function playAgain() {
    resetGame();
}

// Add keyboard support
document.addEventListener('keydown', function(e) {
    if (e.code === 'Space' && !gameState.isGameOver) {
        e.preventDefault();
        pullTrigger();
    }
});

// Update game state periodically
setInterval(updateGameState, 2000);

// Initial game state update
window.addEventListener('load', function() {
    updateGameState();
});
</script>
{% endblock %}
